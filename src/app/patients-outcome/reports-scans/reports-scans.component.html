<!-- 2-Column Layout: Reports List (Left) & Upload Actions (Right) -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8 p-6">

  <!-- Left Side - Reports & Scans List -->
  <div class="mb-6">
    <app-card class="hover-lift">
      <div class="reports-header">
        <h3 class="reports-title">Reports & Scans</h3>
        <div class="header-actions">

          <!-- Search Input-->
          <div class="search-container">
            <input
              type="text"
              [(ngModel)]="quickSearchReports"
              (input)="onSearchReports()"
              placeholder="Search reports..."
              class="search-input-sm"
            />
            <fa-icon [icon]="faSearch" class="search-icon"></fa-icon>
          </div>

          <span class="file-count">{{ reports.length || 0 }} files</span>
          <button (click)="refreshReports()"
            [disabled]="isRefreshing"
            class="btn-sm btn-refresh">
            <fa-icon [icon]="faSync" class="icon-small" [class.spinning]="isRefreshing"></fa-icon>
            <span *ngIf="!isRefreshing">Refresh</span>
            <span *ngIf="isRefreshing">Refreshing...</span>
          </button>
          <!-- <button (click)="openUploadModal()"
            class="btn-sm btn-upload">
            <fa-icon [icon]="faCloudUploadAlt" class="icon-small"></fa-icon>
            Upload
          </button> -->
        </div>
      </div>

      <!-- Filter Tabs -->
      <div class="flex gap-2 mb-4 overflow-x-auto">
        <button *ngFor="let filter of reportFilters" (click)="setActiveFilter(filter.key)"
          [class]="'px-3 py-1.5 text-xs rounded-lg transition-colors whitespace-nowrap ' + (activeFilter === filter.key ? 'bg-blue-100 text-blue-700 font-medium' : 'bg-gray-100 text-gray-600 hover:bg-gray-200')">
          {{ filter.label }} ({{ getFilteredReports(filter.key).length }})
        </button>
      </div>


      <!-- Reports List -->
      <div class="space-y-3">
        <div *ngFor="let report of filteredReports"
          class="bg-white rounded-lg border border-gray-200 p-3 hover:shadow-md transition-all hover-lift">
          <div class="flex items-start gap-3">
            <div
              [class]="'w-10 h-10 rounded-lg flex items-center justify-center flex-shrink-0 text-white text-sm ' + getReportTypeClass(report.type)">
              <fa-icon [icon]="getReportIcon(report.type)" class="w-5 h-5"></fa-icon>
            </div>
            <div class="flex-1 min-w-0">
              <div class="flex items-start justify-between">
                <div class="flex-1 min-w-0">
                  <div class="flex items-center gap-2">
                    <h4 class="font-semibold text-gray-900 text-sm truncate">{{ report.title }}</h4>
                    <!-- <span [class]="'inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium ' + getStatusClass(report?.status || 'reviewed')">
                      {{ report.status | titlecase }}
                    </span> -->
                  </div>
                  <p class="text-xs text-gray-500 mt-0.5">{{ formatDate(report.reportDate) }}</p>
                </div>
                <div class="flex items-center gap-1 ml-2">
                  <button *ngIf="report.analysis" (click)="viewAiAnalysis(report)"
                    class="p-1 text-purple-600 hover:text-purple-800 transition-colors" title="View AI Analysis">
                    <fa-icon [icon]="faBrain" class="w-4 h-4"></fa-icon>
                  </button>
                  <button (click)="viewReport(report)" class="p-1 text-blue-600 hover:text-blue-800 transition-colors"
                    title="View Report">
                    <fa-icon [icon]="faEye" class="w-4 h-4"></fa-icon>
                  </button>
                  <button (click)="downloadReport(report)"
                    class="p-1 text-green-600 hover:text-green-800 transition-colors" title="Download">
                    <fa-icon [icon]="faDownload" class="w-4 h-4"></fa-icon>
                  </button>
                </div>
              </div>
              <div *ngIf="report.analysis"
                class="mt-2 p-2 bg-purple-50 rounded border border-purple-200 cursor-pointer hover:bg-purple-100 transition-colors"
                (click)="viewAiAnalysis(report)">
                <div class="flex items-center justify-between mb-0.5">
                  <div class="text-xs font-semibold text-purple-700">AI ANALYSIS</div>
                  <fa-icon [icon]="faChevronRight" class="w-3 h-3 text-purple-500"></fa-icon>
                </div>
                <p class="text-xs text-gray-700 line-clamp-2">{{ report.analysis }}</p>
                <p class="text-xs text-purple-600 mt-1 font-medium">Click to view full analysis →</p>
              </div>
              <p *ngIf="report.uploadedBy" class="text-xs text-gray-500 mt-1">
                <strong>Uploaded by:</strong> {{ report.uploadedBy }}
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Empty State -->
      <div *ngIf="!currentPatientReports || currentPatientReports.length === 0" class="text-center py-8">
        <fa-icon [icon]="faFileMedical" class="w-12 h-12 mx-auto text-gray-300 mb-3"></fa-icon>
        <p class="text-gray-500 font-semibold">No reports available</p>
        <p class="text-gray-400 text-xs mt-1">Upload reports and scans to get started</p>
      </div>

    </app-card>
  </div>

  <!-- Right Side - Upload Actions -->
  <div class="mb-6">
    <app-card class="hover-lift">
      <h3 class="text-lg font-bold text-gray-900 mb-3">Quick Upload</h3>

      <!-- Quick Upload Buttons -->
      <div class="grid grid-cols-1 gap-3 mb-4">
        <!-- Lab Results -->
        <button (click)="openUploadModal('lab')"
          class="p-3 bg-green-50 border border-green-200 rounded-lg hover:bg-green-100 transition-colors text-left">
          <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-green-500 rounded-lg flex items-center justify-center text-white text-sm">
              <fa-icon [icon]="faFlask" class="w-4 h-4"></fa-icon>
            </div>
            <div class="flex-1">
              <div class="font-semibold text-gray-900 text-sm">Lab Results</div>
              <div class="text-xs text-gray-600">Blood tests, urine analysis, cultures</div>
            </div>
            <fa-icon [icon]="faChevronRight" class="w-4 h-4 text-gray-400"></fa-icon>
          </div>
        </button>

        <!-- Imaging/Scans -->
        <button (click)="openUploadModal('imaging')"
          class="p-3 bg-blue-50 border border-blue-200 rounded-lg hover:bg-blue-100 transition-colors text-left">
          <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center text-white text-sm">
              <fa-icon [icon]="faCamera" class="w-4 h-4"></fa-icon>
            </div>
            <div class="flex-1">
              <div class="font-semibold text-gray-900 text-sm">Imaging & Scans</div>
              <div class="text-xs text-gray-600">X-rays, MRI, CT scans, ultrasounds</div>
            </div>
            <fa-icon [icon]="faChevronRight" class="w-4 h-4 text-gray-400"></fa-icon>
          </div>
        </button>

        <!-- Medical Reports -->
        <button (click)="openUploadModal('report')"
          class="p-3 bg-purple-50 border border-purple-200 rounded-lg hover:bg-purple-100 transition-colors text-left">
          <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-purple-500 rounded-lg flex items-center justify-center text-white text-sm">
              <fa-icon [icon]="faFileAlt" class="w-4 h-4"></fa-icon>
            </div>
            <div class="flex-1">
              <div class="font-semibold text-gray-900 text-sm">Medical Reports</div>
              <div class="text-xs text-gray-600">Consultation notes, discharge summaries</div>
            </div>
            <fa-icon [icon]="faChevronRight" class="w-4 h-4 text-gray-400"></fa-icon>
          </div>
        </button>

        <!-- Prescriptions -->
        <button (click)="openUploadModal('prescription')"
          class="p-3 bg-orange-50 border border-orange-200 rounded-lg hover:bg-orange-100 transition-colors text-left">
          <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-orange-500 rounded-lg flex items-center justify-center text-white text-sm">
              <fa-icon [icon]="faPills" class="w-4 h-4"></fa-icon>
            </div>
            <div class="flex-1">
              <div class="font-semibold text-gray-900 text-sm">Prescriptions</div>
              <div class="text-xs text-gray-600">Medication prescriptions, dosage charts</div>
            </div>
            <fa-icon [icon]="faChevronRight" class="w-4 h-4 text-gray-400"></fa-icon>
          </div>
        </button>
      </div>

      <!-- Recent Activity -->
      <div class="mt-4 p-3 bg-gray-50 rounded-lg">
        <div class="flex items-center justify-between mb-2">
          <div class="flex items-center gap-2">
            <fa-icon [icon]="faClock" class="w-4 h-4 text-gray-600"></fa-icon>
            <span class="text-sm font-semibold text-gray-900">Recent Activity</span>
          </div>
        </div>
        <div class="text-xs text-gray-600 space-y-1">
          <p>• Last upload: {{ getLastUploadTime() || 'No recent uploads' }}</p>
          <p>• Pending review: {{ getPendingReportsCount() }} reports</p>
          <p>• AI analysis: {{ getAiAnalyzedCount() }} completed</p>
        </div>
      </div>

      <!-- Drag & Drop Zone -->
      <div
        class="mt-4 p-4 border-2 border-dashed border-gray-300 rounded-lg text-center hover:border-blue-400 transition-colors cursor-pointer"
        (click)="triggerFileInput()" (dragover)="onDragOver($event)" (dragleave)="onDragLeave($event)"
        (drop)="onDrop($event)">
        <fa-icon [icon]="faCloudUploadAlt" class="w-8 h-8 mx-auto text-gray-400 mb-2"></fa-icon>
        <p class="text-sm font-medium text-gray-700">Drop files here or click to browse</p>
        <p class="text-xs text-gray-500 mt-1">PDF, JPG, PNG, DICOM files up to 50MB</p>
        <input #fileInput type="file" multiple accept=".pdf,.jpg,.jpeg,.png,.dcm,.dicom" class="hidden"
          (change)="onFileSelected($event)">
      </div>
    </app-card>
  </div>

</div>

<!-- Upload Modal -->
<div *ngIf="showUploadModal" class="fixed inset-0 z-50 overflow-y-auto" (click)="closeUploadModal()">
  <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
    <!-- Background overlay -->
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>

    <!-- Modal panel -->
    <div
      class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full"
      (click)="$event.stopPropagation()">
      <!-- Modal Header -->
      <div class="bg-white px-6 py-4 border-b border-gray-200">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-semibold text-gray-900">Upload {{ getUploadTypeLabel() }}</h3>
          <button (click)="closeUploadModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
            <fa-icon [icon]="faTimes" class="w-6 h-6"></fa-icon>
          </button>
        </div>
      </div>

      <!-- Modal Body -->
      <div class="bg-white px-6 py-4 relative">
        <!-- Loading Overlay -->
        <div *ngIf="isUploading"
          class="absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center z-10 rounded">
          <div class="text-center">
            <svg class="animate-spin h-10 w-10 text-blue-600 mx-auto mb-2" xmlns="http://www.w3.org/2000/svg"
              fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor"
                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
              </path>
            </svg>
            <p class="text-sm font-medium text-gray-700">Uploading files...</p>
            <p class="text-xs text-gray-500 mt-1">Please wait</p>
          </div>
        </div>

        <form (ngSubmit)="uploadReport()" #uploadForm="ngForm">
          <!-- File Selection -->
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Select Files</label>
            <div
              class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:border-blue-400 transition-colors cursor-pointer"
              [class.pointer-events-none]="isUploading" [class.opacity-50]="isUploading"
              (click)="triggerModalFileInput()">
              <fa-icon [icon]="faCloudUploadAlt" class="w-8 h-8 mx-auto text-gray-400 mb-2"></fa-icon>
              <p class="text-sm text-gray-600">Click to select files or drag and drop</p>
              <input #modalFileInput type="file" multiple accept=".pdf,.jpg,.jpeg,.png,.dcm,.dicom" class="hidden"
                (change)="onModalFileSelected($event)" [disabled]="isUploading">
            </div>
            <div *ngIf="selectedFiles.length > 0" class="mt-2">
              <p class="text-sm font-medium text-gray-700 mb-1">Selected files:</p>
              <div class="space-y-1">
                <div *ngFor="let file of selectedFiles"
                  class="flex items-center justify-between text-xs bg-gray-50 p-2 rounded">
                  <span>{{ file.name }}</span>
                  <button type="button" (click)="removeFile(file)" [disabled]="isUploading"
                    class="text-red-600 hover:text-red-800 disabled:opacity-50 disabled:cursor-not-allowed">
                    <fa-icon [icon]="faTimes" class="w-4 h-4"></fa-icon>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>

      <!-- Modal Footer -->
      <div class="bg-gray-50 px-6 py-3 flex justify-end gap-3 border-t border-gray-200">
        <button (click)="closeUploadModal()" [disabled]="isUploading"
          class="px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
          Cancel
        </button>
        <button (click)="uploadReport()" [disabled]="!isUploadFormValid() || isUploading"
          class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
          <svg *ngIf="isUploading" class="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg"
            fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
            </path>
          </svg>
          <span>{{ isUploading ? 'Uploading...' : 'Upload Reports' }}</span>
        </button>
      </div>
    </div>
  </div>
</div>


<!-- AI Analysis Modal -->
<div *ngIf="showAiAnalysisModal" class="fixed inset-0 z-50 overflow-y-auto" (click)="closeAiAnalysisModal()">
  <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
    <!-- Background overlay -->
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>

    <!-- Modal panel -->
    <div
      class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-3xl sm:w-full"
      (click)="$event.stopPropagation()">
      <!-- Modal Header -->
      <div class="bg-gradient-to-r from-purple-600 to-blue-600 px-6 py-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
              <fa-icon [icon]="faBrain" class="w-5 h-5 text-white"></fa-icon>
            </div>
            <div>
              <h3 class="text-lg font-semibold text-white">AI Analysis Report</h3>
              <p class="text-xs text-purple-100" *ngIf="currentAnalysisReport">{{ currentAnalysisReport.title }}</p>
            </div>
          </div>
          <button (click)="closeAiAnalysisModal()" class="text-white hover:text-purple-100 transition-colors">
            <fa-icon [icon]="faTimes" class="w-6 h-6"></fa-icon>
          </button>
        </div>
      </div>

      <!-- Modal Body -->
      <div class="bg-white px-6 py-6 max-h-[70vh] overflow-y-auto">
        <div *ngIf="currentAnalysisReport">
          <!-- Report Info -->
          <div class="mb-6 pb-4 border-b border-gray-200">
            <div class="grid grid-cols-2 gap-4">
              <div>
                <p class="text-xs text-gray-500 mb-1">Report Type</p>
                <div class="flex items-center gap-2">
                  <div
                    [class]="'w-6 h-6 rounded flex items-center justify-center text-white text-xs ' + getReportTypeClass(currentAnalysisReport.type)">
                    <fa-icon [icon]="getReportIcon(currentAnalysisReport.type)" class="w-3 h-3"></fa-icon>
                  </div>
                  <p class="text-sm font-medium text-gray-900">{{ currentAnalysisReport.type | titlecase }}</p>
                </div>
              </div>
              <div>
                <p class="text-xs text-gray-500 mb-1">Report Date</p>
                <p class="text-sm font-medium text-gray-900">{{ formatDate(currentAnalysisReport.reportDate) }}</p>
              </div>
            </div>
          </div>

          <!-- AI Analysis Content -->
          <div class="space-y-4">
            <div class="flex items-start gap-2">
              <div class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center flex-shrink-0 mt-1">
                <fa-icon [icon]="faRobot" class="w-4 h-4 text-purple-600"></fa-icon>
              </div>
              <div class="flex-1">
                <h4 class="text-sm font-semibold text-gray-900 mb-2">AI-Generated Analysis</h4>
                <div class="prose prose-sm max-w-none">
                  <p class="text-sm text-gray-700 leading-relaxed whitespace-pre-line">
                    {{ currentAnalysisReport.analysis }}</p>
                </div>
              </div>
            </div>

            <!-- Analysis Metadata -->
            <div class="mt-6 p-4 bg-gray-50 rounded-lg">
              <div class="flex items-center gap-2 text-xs text-gray-600">
                <fa-icon [icon]="faClock" class="w-3 h-3"></fa-icon>
                <span>Analyzed on
                  {{ formatDate(currentAnalysisReport.uploadedAt || currentAnalysisReport.reportDate) }}</span>
              </div>
              <div class="mt-2 text-xs text-gray-500">
                <p class="italic">This analysis was generated by AI and should be reviewed by a qualified healthcare
                  professional.</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Empty State -->
        <div *ngIf="!currentAnalysisReport?.analysis" class="text-center py-8">
          <fa-icon [icon]="faRobot" class="w-12 h-12 mx-auto text-gray-300 mb-3"></fa-icon>
          <p class="text-gray-500 font-semibold">No AI analysis available</p>
          <p class="text-gray-400 text-xs mt-1">This report has not been analyzed yet</p>
        </div>
      </div>

      <!-- Modal Footer -->
      <div class="bg-gray-50 px-6 py-4 flex justify-between items-center border-t border-gray-200">
        <div class="flex items-center gap-2">
          <button (click)="viewReport(currentAnalysisReport!)"
            class="px-4 py-2 text-blue-700 bg-blue-50 border border-blue-200 rounded-lg hover:bg-blue-100 transition-colors text-sm flex items-center gap-2">
            <fa-icon [icon]="faEye" class="w-3 h-3"></fa-icon>
            View Full Report
          </button>
          <button (click)="downloadReport(currentAnalysisReport!)"
            class="px-4 py-2 text-green-700 bg-green-50 border border-green-200 rounded-lg hover:bg-green-100 transition-colors text-sm flex items-center gap-2">
            <fa-icon [icon]="faDownload" class="w-3 h-3"></fa-icon>
            Download
          </button>
        </div>
        <button (click)="closeAiAnalysisModal()"
          class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors text-sm">
          Close
        </button>
      </div>
    </div>
  </div>
</div>


<!-- Document Viewer Modal -->
<app-document-viewer [isOpen]="showDocumentViewer" [document]="currentDocument" (closeEvent)="closeDocumentViewer()">
</app-document-viewer>

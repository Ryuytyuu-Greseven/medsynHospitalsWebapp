<div class="main-grid">


  <!-- Medication Insights -->
  <!-- <div class="mb-6">
      <div class="card card-hover-lift card-h-fit card-min-h-300">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-lg font-bold text-gray-900">Medication Insights</h3>
          <fa-icon [icon]="faExclamationTriangle" class="w-5 h-5 text-blue-600"></fa-icon>
        </div>

        <div class="grid grid-cols-2 gap-3 mb-3">
          <div class="bg-blue-50 rounded-lg p-3 text-center">
            <div class="text-xl font-bold text-blue-600">{{ medications.length }}</div>
            <div class="text-xs text-blue-700">Active Meds</div>
          </div>
          <div class="bg-green-50 rounded-lg p-3 text-center">
            <div class="text-xl font-bold text-green-600">{{ getUpcomingRefills() }}</div>
            <div class="text-xs text-green-700">Refills Due</div>
          </div>
        </div>

        <div>
          <h4 class="text-sm font-semibold text-gray-700 mb-2">Recent Activity</h4>
          <div class="space-y-1">
            <div *ngFor="let activity of getRecentActivity()" class="flex items-center gap-2 text-xs text-gray-600">
              <fa-icon [icon]="activity.icon" class="w-3 h-3" [class]="activity.colorClass"></fa-icon>
              <span>{{ activity.description }}</span>
            </div>
          </div>
        </div>
      </div>
    </div> -->

  <!-- Left Side - Medications -->
 <div class="medications-container">

   <!-- Current Medications -->
   <div class="section-spacing">
     <div class="card card-hover-lift card-h-fit card-mid">
       <div class="meds-modern-header">
         <div class="meds-header-left">
           <div class="meds-title-group">
             <h3 class="meds-main-title">Current Medications</h3>
             <!-- <span class="meds-count-badge">{{ medications.length || 0 }}</span> -->
           </div>
         </div>
         <div class="meds-header-actions">
           <div class="meds-search-wrapper">
             <fa-icon [icon]="faSearch" class="meds-search-icon"></fa-icon>
             <input type="text" [(ngModel)]="quickSearchTerm" (keyup.enter)="quickSearchMedication()"
               placeholder="Search..." class="meds-search-input" />
           </div>
           <button class="diet-view-btn" (click)="openMedicationsModal()">
             <span>View All</span>
           </button>
         </div>
       </div>

       <!-- Empty State -->
       <div *ngIf="!medications || medications.length === 0" class="meds-empty-state">
         <div class="meds-empty-icon">
           <fa-icon [icon]="faPills"></fa-icon>
         </div>
         <p class="meds-empty-text">No active medications</p>
       </div>

       <!-- Medications Grid Layout -->
       <div *ngIf="medications && medications.length > 0" class="meds-modern-grid">
         <div *ngFor="let meds of medications; let i = index" class="meds-modern-card">
           <div class="meds-card-top">
             <div class="meds-pill-icon">{{ meds.name | titlecase }}</div>
             <!-- <div class="meds-status-dot active"></div> -->
           </div>

           <!-- <div class="meds-card-body">
             <h4 class="meds-drug-name">ðŸ’Š {{ meds.name }}</h4>
           </div> -->

           <div class="meds-card-divider"></div>

           <div class="meds-card-footer">
             <div class="meds-meta-item">
               <span class="meds-meta-label">{{meds.dosage.slice(0,15)}}</span>
               <span class="meds-meta-value">{{ meds.frequency }}</span>
             </div>
             <div class="meds-meta-item">
               <span class="meds-meta-label">Since</span>
               <span class="meds-meta-value">{{ formatDate(meds.startDate) }}</span>
             </div>
           </div>
         </div>
       </div>
     </div>
   </div>
 </div>


  <!-- Current Diet -->
  <div class="section-spacing" *ngIf="dietPlan as plan">
    <div class="card card-hover-lift card-h-fit card-mid">
      <div class="diet-header">
        <div class="diet-title-meta">
          <h3 class="diet-title">Current Diet Plan</h3>
          <span class="diet-subtitle">Started {{ plan.startDate | date: 'MMM d, y' }}</span>
        </div>
        <div class="diet-header-actions">
          <button class="ai-spark-btn" (click)="openAIDietInstructionsModal()">
            <fa-icon [icon]="faWandMagicSparkles" class="ai-spark-icon"></fa-icon>
            <span>AI Generate</span>
          </button>
          <button class="diet-view-btn" (click)="openDietPlanModal(dietPlan)">View plan</button>
        </div>
      </div>

      <div class="diet-card">
        <div class="diet-card-header">
          <div class="diet-icon-container">
            <span class="diet-icon">ðŸ¥—</span>
          </div>
          <div class="diet-info">
            <h4 class="diet-name">{{ plan.name }}</h4>
            <p class="diet-description">{{ plan.description }}</p>
          </div>
        </div>

        <div class="diet-summary-inline">
          <div class="diet-summary-field">
            <span class="diet-summary-label">Prescribed by</span>
            <span class="diet-summary-value">{{ plan.doctor }}</span>
          </div>
        </div>

        <div class="diet-targets">
          <div class="diet-target" *ngFor="let metric of macroStatDefinitions">
            <span class="diet-target-label">{{ metric?.label }}</span>
            <span class="diet-target-value">{{ plan?.dailyTargets?.[metric.key] }} {{ metric?.unit }}</span>
            <span class="diet-target-subtext">Daily target</span>
          </div>
        </div>
      </div>
    </div>
  </div>


  <!-- Quick Actions -->
  <div class="section-spacing">
    <div class="card card-hover-lift card-h-fit card-min-h-300">
      <div class="quick-actions-header">
        <h3 class="quick-actions-title">Quick Actions</h3>
        <fa-icon [icon]="faPlus" class="quick-actions-icon"></fa-icon>
      </div>

      <div class="quick-actions-list">
        <button (click)="openImageUpload()" class="action-button action-button-blue">
          <div class="action-button-content">
            <fa-icon [icon]="faCamera" class="action-icon" style="color: #2563eb;"></fa-icon>
            <div class="action-text">
              <div class="action-title">Scan Prescription</div>
              <div class="action-subtitle">Upload image or PDF</div>
            </div>
          </div>
        </button>

        <button (click)="openAddMedicationModal()" class="action-button action-button-green">
          <div class="action-button-content">
            <fa-icon [icon]="faPills" class="action-icon" style="color: #16a34a;"></fa-icon>
            <div class="action-text">
              <div class="action-title">Add Manually</div>
              <div class="action-subtitle">Enter details manually</div>
            </div>
          </div>
        </button>

        <button (click)="exportMedications()" class="action-button action-button-purple">
          <div class="action-button-content">
            <fa-icon [icon]="faDownload" class="action-icon" style="color: #9333ea;"></fa-icon>
            <div class="action-text">
              <div class="action-title">Export List</div>
              <div class="action-subtitle">Download medication list</div>
            </div>
          </div>
        </button>
      </div>
    </div>
  </div>

  <!-- Nutrition & Activity -->
  <!-- <div class="section-spacing">
    <div class="card card-hover-lift card-h-fit card-min-h-300">
      <h3 class="nutrition-header">Daily Nutrition & Activity</h3>

      <div class="nutrition-section">
        <h4 class="nutrition-section-title">Nutrition Intake</h4>
        <div class="nutrition-grid">
          <div class="nutrition-card nutrition-card-orange">
            <div class="nutrition-value nutrition-value-orange">1,850</div>
            <div class="nutrition-label nutrition-label-orange">Calories</div>
          </div>

          <div class="nutrition-card nutrition-card-blue">
            <div class="nutrition-value nutrition-value-blue">85g</div>
            <div class="nutrition-label nutrition-label-blue">Protein</div>
          </div>

          <div class="nutrition-card nutrition-card-yellow">
            <div class="nutrition-value nutrition-value-yellow">120g</div>
            <div class="nutrition-label nutrition-label-yellow">Carbs</div>
          </div>

          <div class="nutrition-card nutrition-card-purple">
            <div class="nutrition-value nutrition-value-purple">65g</div>
            <div class="nutrition-label nutrition-label-purple">Fat</div>
          </div>
        </div>
      </div>

      <div>
        <h4 class="nutrition-section-title">Activity & Burning</h4>
        <div class="nutrition-grid">
          <div class="nutrition-card nutrition-card-red">
            <div class="nutrition-value nutrition-value-red">420</div>
            <div class="nutrition-label nutrition-label-red">Calories Burned</div>
          </div>

          <div class="nutrition-card nutrition-card-green">
            <div class="nutrition-value nutrition-value-green">6,250</div>
            <div class="nutrition-label nutrition-label-green">Steps</div>
          </div>

          <div class="nutrition-card nutrition-card-blue">
            <div class="nutrition-value nutrition-value-blue">3.2</div>
            <div class="nutrition-label nutrition-label-blue">Miles</div>
          </div>

          <div class="nutrition-card nutrition-card-purple">
            <div class="nutrition-value nutrition-value-purple">45</div>
            <div class="nutrition-label nutrition-label-purple">Active Minutes</div>
          </div>
        </div>
      </div>
    </div>
  </div> -->

  <!-- Inactive Diet Plans -->
  <div class="section-spacing" *ngIf="inactiveDietPlans && inactiveDietPlans.length > 0">
    <div class="card card-hover-lift card-h-fit card-mid">
      <h3 class="inactive-plans-title">Previous Diet Plans</h3>
      <div class="inactive-plans-list">
        <div *ngFor="let plan of inactiveDietPlans; let i = index" class="inactive-plan-card">
          <div class="inactive-plan-content">
            <div class="inactive-plan-icon">ðŸ“‹</div>
            <div class="inactive-plan-info">
              <h4 class="inactive-plan-name">{{ plan.name }}</h4>
              <p class="inactive-plan-meta">{{ plan.doctor }} Â· {{ plan.startDate | date: 'MMM y' }}</p>
            </div>
          </div>
          <button class="inactive-plan-view-btn" (click)="viewInactivePlan(plan)">View</button>
        </div>
      </div>
    </div>
  </div>


</div>

<!-- Medications Modal -->
<div *ngIf="showMedicationsModal" class="modal-overlay">
  <div class="modal-container">
    <!-- Background overlay -->
    <div class="modal-backdrop"></div>

    <!-- Modal panel -->
    <div class="modal-panel modal-panel-xl" (click)="$event.stopPropagation()">
      <!-- Modal Header -->
      <div class="modal-header-enhanced">
        <!-- Top Section: Title & Actions -->
        <div class="modal-header-top">
          <div class="modal-title-section">
            <div class="modal-icon-badge">
              <fa-icon [icon]="faPills" class="modal-main-icon"></fa-icon>
            </div>
            <div class="modal-title-content">
              <h3 class="modal-main-title">Patient Medications</h3>
              <p class="modal-main-subtitle">View, search, and manage all prescribed medications</p>
            </div>
          </div>

          <div class="modal-header-actions">
            <button (click)="closeMedicationsModal()" class="close-btn-enhanced">
              <fa-icon [icon]="faTimes" class="close-icon"></fa-icon>
            </button>
          </div>
        </div>

        <!-- Search & Filter Section -->
        <div class="modal-search-section">
          <!-- Compact Search & Filter Row -->
          <div class="search-filter-row">
            <!-- Compact Search Bar -->
            <div class="search-bar-compact">
              <div class="search-icon-wrapper">
                <fa-icon [icon]="faSearch" class="search-icon-new"></fa-icon>
              </div>
              <input
                type="text"
                [(ngModel)]="medicationSearchTerm"
                (input)="filterMedications()"
                placeholder="Search medications..."
                class="search-input-compact">
              <div *ngIf="medicationSearchTerm" class="clear-search-btn" (click)="medicationSearchTerm = ''; filterMedications()">
                <fa-icon [icon]="faTimes" class="clear-icon"></fa-icon>
              </div>
            </div>

            <!-- Compact Status Filter -->
            <div class="filter-compact">
              <div class="custom-select-wrapper">
                <select [(ngModel)]="selectedStatusFilter" (change)="filterMedications()" class="custom-select-compact">
                  <option value="all">All Status</option>
                  <option value="active">Active</option>
                  <option value="discontinued">Discontinued</option>
                  <option value="paused">Paused</option>
                </select>
                <svg class="select-arrow-compact" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
              </div>
            </div>

            <div class="export-btn-wrapper">
              <button (click)="exportMedications()" class="action-btn action-btn-export">
                <fa-icon [icon]="faDownload" class="action-btn-icon-fa"></fa-icon>
                <span class="action-btn-text">Export</span>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal Body -->
      <div class="modal-body">
        <div class="medications-list">

          <!-- Medication Tabs -->
          <div class="medications-tab-group">
            <button
              type="button"
              (click)="selectedMedicationTab = 'active'"
              class="medication-tab"
              [ngClass]="{ 'medication-tab-active': selectedMedicationTab === 'active' }">
              <span>Current Medications</span>
              <span
                class="medication-tab-count"
                [ngClass]="{ 'medication-tab-count-active': selectedMedicationTab === 'active' }">
                {{ getFilteredMedications('active').length }}
              </span>
            </button>
            <button
              type="button"
              (click)="selectedMedicationTab = 'discontinued'"
              class="medication-tab"
              [ngClass]="{ 'medication-tab-active': selectedMedicationTab === 'discontinued' }">
              <span>Previous Medications</span>
              <span
                class="medication-tab-count"
                [ngClass]="{ 'medication-tab-count-active': selectedMedicationTab === 'discontinued' }">
                {{ getFilteredMedications('discontinued').length }}
              </span>
            </button>
          </div>

          <!-- Current Medications Tab Content -->
          <div *ngIf="selectedMedicationTab === 'active'" class="medication-tab-content">
            <div *ngIf="getFilteredMedications('active').length > 0; else noActiveMedications">
              <div class="medications-grid-modal">
                <div *ngFor="let med of getFilteredMedications('active')" class="medication-card-modal">
                  <div class="medication-card-header">
                    <div class="medication-card-content">
                      <div class="medication-name-row">
                        <h5 class="medication-name-modal">{{ med.name }}</h5>
                        <span class="status-badge status-badge-active">
                          Active
                        </span>
                      </div>
                      <div class="medication-details-list">
                        <p class="medication-detail-item"><span class="medication-detail-label">Dosage:</span>
                          {{ med.dosage.slice(0, 10) + '...' }}</p>
                        <p class="medication-detail-item"><span class="medication-detail-label">Frequency:</span>
                          {{ med.frequency }}</p>
                        <p class="medication-detail-item"><span class="medication-detail-label">Started:</span>
                          {{ formatDate(med.startDate) }}</p>
                        <p *ngIf="med.prescribedBy" class="medication-detail-item"><span
                            class="medication-detail-label">Prescribed by:</span> {{ med.prescribedBy }}</p>
                        <p *ngIf="med.notes" class="medication-notes">
                          <span class="medication-detail-label">Notes:</span> {{ med.notes }}
                        </p>
                      </div>
                    </div>
                    <div class="medication-actions">
                      <button (click)="viewPrescription(med)" class="action-icon-btn action-icon-btn-green"
                        title="View Prescription">
                        <fa-icon [icon]="faEye" class="action-icon-size"></fa-icon>
                      </button>
                      <button (click)="editMedication(med)" class="action-icon-btn action-icon-btn-blue" title="Edit">
                        <fa-icon [icon]="faEdit" class="action-icon-size"></fa-icon>
                      </button>
                      <button (click)="discontinueMedication(med)" class="action-icon-btn action-icon-btn-red"
                        title="Discontinue">
                        <fa-icon [icon]="faTimes" class="action-icon-size"></fa-icon>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <ng-template #noActiveMedications>
              <div class="medications-empty-state">
                <div class="empty-state-icon-large">
                  <fa-icon [icon]="faPills"></fa-icon>
                </div>
                <p class="empty-state-text-modal">No active medications found</p>
              </div>
            </ng-template>
          </div>

          <!-- Previous Medications Tab Content -->
          <div *ngIf="selectedMedicationTab === 'discontinued'" class="medication-tab-content">
            <div *ngIf="getFilteredMedications('discontinued').length > 0; else noDiscontinuedMedications">
              <div class="medications-grid-modal">
                <div *ngFor="let med of getFilteredMedications('discontinued')"
                  class="medication-card-modal medication-card-disabled">
                  <div class="medication-card-header">
                    <div class="medication-card-content">
                      <div class="medication-name-row">
                        <h5 class="medication-name-modal">{{ med.name }}</h5>
                        <span class="status-badge status-badge-discontinued">
                          Discontinued
                        </span>
                      </div>
                      <div class="medication-details-list">
                        <p class="medication-detail-item"><span class="medication-detail-label">Dosage:</span>
                          {{ med.dosage.slice(0, 10) + '...' }}</p>
                        <p class="medication-detail-item"><span class="medication-detail-label">Duration:</span>
                          {{ formatDate(med.startDate) }} - {{ med.endDate ? formatDate(med.endDate) : 'Ongoing' }}</p>
                        <p *ngIf="med.discontinueReason" class="medication-notes">
                          <span class="medication-detail-label">Reason:</span> {{ med.discontinueReason }}
                        </p>
                      </div>
                    </div>
                    <div class="medication-actions">
                      <button (click)="viewMedicationHistory(med)" class="action-icon-btn action-icon-btn-gray"
                        title="View History">
                        <fa-icon [icon]="faHistory" class="action-icon-size"></fa-icon>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <ng-template #noDiscontinuedMedications>
              <div class="medications-empty-state">
                <div class="empty-state-icon-large">
                  <fa-icon [icon]="faHistory"></fa-icon>
                </div>
                <p class="empty-state-text-modal">No discontinued medications found</p>
              </div>
            </ng-template>
          </div>

        </div>
      </div>

    </div>
  </div>
</div>

<!-- Image Upload Modal -->
<div *ngIf="showImageUploadModal" class="modal-overlay" (click)="closeImageUploadModal()">
  <div class="modal-container">
    <!-- Background overlay -->
    <div class="modal-backdrop"></div>

    <!-- Modal panel -->
    <div class="modal-panel" (click)="$event.stopPropagation()">
      <!-- Modal Header -->
      <div class="modal-header">
        <div class="modal-header-content">
          <div class="modal-header-left">
            <div class="modal-icon-container modal-icon-container-blue">
              <fa-icon [icon]="faCamera" class="modal-icon modal-icon-blue"></fa-icon>
            </div>
            <div class="modal-title-group">
              <h3 class="modal-title">Upload Prescription</h3>
              <p class="modal-subtitle">AI will automatically extract medication details</p>
            </div>
          </div>
          <button (click)="closeImageUploadModal()" class="modal-close-btn">
            <fa-icon [icon]="faTimes" class="w-6 h-6"></fa-icon>
          </button>
        </div>
      </div>

      <!-- Modal Body -->
      <div class="modal-body-white px-6 py-4">
        <!-- Upload Area -->
        <div [class]="'upload-area ' + (isUploadingMedication ? 'upload-area-disabled' : '')"
          (click)="!isUploadingMedication && triggerFileInput()"
          (dragover)="!isUploadingMedication && onDragOver($event)"
          (dragleave)="!isUploadingMedication && onDragLeave($event)" (drop)="!isUploadingMedication && onDrop($event)">
          <fa-icon [icon]="faCamera" class="upload-icon-large"></fa-icon>
          <p class="upload-title">Upload Prescription Image</p>
          <p class="upload-subtitle">Drag and drop or click to browse</p>
          <p class="upload-hint">Supports JPG, PNG, PDF files up to 10MB</p>
          <input #fileInput type="file" accept=".jpg,.jpeg,.png,.pdf" class="file-input-hidden"
            (change)="onFileSelected($event)" [disabled]="isUploadingMedication">
        </div>

        <!-- Preview -->
        <div *ngIf="uploadedImage" class="preview-container">
          <h4 class="preview-title">Uploaded Image</h4>
          <div class="preview-image-container">
            <img [src]="uploadedImage" alt="Prescription preview" class="preview-image">
            <button (click)="removeUploadedImage()" [disabled]="isUploadingMedication" class="preview-remove-btn">
              <fa-icon [icon]="faTimes" class="w-3 h-3"></fa-icon>
            </button>
          </div>
        </div>

        <!-- AI Processing -->
        <div *ngIf="isProcessingImage" class="mt-4">
          <app-loading text="AI is analyzing your prescription..." size="md">
          </app-loading>
        </div>

        <!-- Extracted Data Preview -->
        <div *ngIf="extractedMedicationData" class="extracted-data">
          <h4 class="extracted-data-title">Extracted Information</h4>
          <div class="extracted-data-list">
            <div class="extracted-data-item"><span class="extracted-data-label">Medication:</span>
              {{ extractedMedicationData.name }}</div>
            <div class="extracted-data-item"><span class="extracted-data-label">Dosage:</span>
              {{ extractedMedicationData.dosage }}</div>
            <div class="extracted-data-item"><span class="extracted-data-label">Frequency:</span>
              {{ extractedMedicationData.frequency }}</div>
            <div *ngIf="extractedMedicationData.instructions" class="extracted-data-item"><span
                class="extracted-data-label">Instructions:</span> {{ extractedMedicationData.instructions }}</div>
          </div>
          <div class="extracted-data-actions">
            <button (click)="confirmExtractedData()" class="extracted-data-btn extracted-data-btn-confirm">
              Confirm & Add
            </button>
            <button (click)="editExtractedData()" class="extracted-data-btn extracted-data-btn-edit">
              Edit Details
            </button>
          </div>
        </div>
      </div>

      <!-- Modal Footer -->
      <div class="modal-footer">
        <div></div>
        <div class="modal-footer-right">
          <button (click)="closeImageUploadModal()" [disabled]="isUploadingMedication"
            class="form-button form-button-cancel">
            Cancel
          </button>
          <button (click)="processImage()" [disabled]="!uploadedImage || isUploadingMedication"
            class="form-button form-button-process">
            <!-- Loading Spinner - Keep Tailwind for animation -->
            <svg *ngIf="isUploadingMedication" class="animate-spin h-4 w-4 text-white"
              xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor"
                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
              </path>
            </svg>
            <fa-icon *ngIf="!isUploadingMedication" [icon]="faCamera" class="w-4 h-4"></fa-icon>
            <span>{{ isUploadingMedication ? 'Uploading...' : 'Process with AI' }}</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add Medication Modal -->
<div *ngIf="showAddMedicationModal" class="modal-overlay" (click)="closeAddMedicationModal()">
  <div class="modal-container">
    <!-- Background overlay -->
    <div class="modal-backdrop"></div>

    <!-- Modal panel -->
    <div class="modal-panel modal-panel-lg" (click)="$event.stopPropagation()">
      <!-- Modal Header -->
      <div class="modal-header">
        <div class="modal-header-content">
          <div class="modal-header-left">
            <div class="modal-icon-container modal-icon-container-green">
              <fa-icon [icon]="faPills" class="modal-icon modal-icon-green"></fa-icon>
            </div>
            <div class="modal-title-group">
              <h3 class="modal-title">Add New Medication</h3>
              <p class="modal-subtitle">Enter medication details and dosage information</p>
            </div>
          </div>
          <button (click)="closeAddMedicationModal()" class="modal-close-btn">
            <fa-icon [icon]="faTimes" class="w-6 h-6"></fa-icon>
          </button>
        </div>
      </div>

      <!-- Modal Body -->
      <div class="modal-body-white px-6 py-4">
        <form [formGroup]="medicationForm" (ngSubmit)="addMedication()">
          <div class="form-grid">
            <!-- Medication Name -->
            <div class="form-field-full">
              <label class="form-label form-label-icon">
                <fa-icon [icon]="faPills" class="w-4 h-4" style="color: #2563eb;"></fa-icon>
                Medication Name *
              </label>
              <input type="text" formControlName="name" class="form-input" placeholder="e.g., Metformin, Lisinopril">
            </div>

            <!-- Dosage -->
            <div>
              <label class="form-label form-label-icon">
                <fa-icon [icon]="faExclamationTriangle" class="w-4 h-4" style="color: #ea580c;"></fa-icon>
                Dosage *
              </label>
              <input type="text" formControlName="dosage" class="form-input" placeholder="e.g., 500mg, 10mg">
            </div>

            <!-- Frequency -->
            <div>
              <label class="form-label form-label-icon">
                <fa-icon [icon]="faCalendarAlt" class="w-4 h-4" style="color: #9333ea;"></fa-icon>
                Frequency *
              </label>
              <select formControlName="frequency" class="form-select">
                <option value="">Select frequency</option>
                <option value="Once daily">Once daily</option>
                <option value="Twice daily">Twice daily</option>
                <option value="Three times daily">Three times daily</option>
                <option value="Four times daily">Four times daily</option>
                <option value="As needed">As needed</option>
                <option value="Weekly">Weekly</option>
                <option value="Monthly">Monthly</option>
              </select>
            </div>

            <!-- Times Per Day -->
            <div>
              <label class="form-label form-label-icon">
                <fa-icon [icon]="faCalendarAlt" class="w-4 h-4" style="color: #16a34a;"></fa-icon>
                Times Per Day
              </label>
              <input type="number" formControlName="timesPerDay" min="1" max="10" class="form-input"
                placeholder="e.g., 2">
            </div>

            <!-- Start Date -->
            <div>
              <label class="form-label form-label-icon">
                <fa-icon [icon]="faCalendarAlt" class="w-4 h-4" style="color: #2563eb;"></fa-icon>
                Start Date *
              </label>
              <input type="date" formControlName="startDate" class="form-input">
            </div>

            <!-- Prescribed By -->
            <div>
              <label class="form-label form-label-icon">
                <fa-icon [icon]="faUserMd" class="w-4 h-4" style="color: #6366f1;"></fa-icon>
                Prescribed By
              </label>
              <input type="text" formControlName="prescribedBy" class="form-input" placeholder="e.g., Dr. Smith">
            </div>

            <!-- Description -->
            <div class="form-field-full">
              <label class="form-label form-label-icon">
                <fa-icon [icon]="faFileMedical" class="w-4 h-4" style="color: #14b8a6;"></fa-icon>
                Description
              </label>
              <textarea formControlName="description" rows="2" class="form-textarea"
                placeholder="Brief description of the medication and its purpose..."></textarea>
            </div>

            <!-- Instructions -->
            <div class="form-field-full">
              <label class="form-label form-label-icon">
                <fa-icon [icon]="faFileMedical" class="w-4 h-4" style="color: #f59e0b;"></fa-icon>
                Special Instructions
              </label>
              <textarea formControlName="instructions" rows="2" class="form-textarea"
                placeholder="e.g., Take with food, Take before bedtime, Avoid alcohol..."></textarea>
            </div>

            <!-- Side Effects -->
            <div class="form-field-full">
              <label class="form-label form-label-icon">
                <fa-icon [icon]="faExclamationTriangle" class="w-4 h-4" style="color: #dc2626;"></fa-icon>
                Potential Side Effects
              </label>
              <textarea formControlName="sideEffects" rows="2" class="form-textarea"
                placeholder="e.g., Nausea, dizziness, headache..."></textarea>
            </div>

            <!-- Drug Interactions -->
            <div class="form-field-full">
              <label class="form-label form-label-icon">
                <fa-icon [icon]="faExclamationTriangle" class="w-4 h-4" style="color: #ea580c;"></fa-icon>
                Drug Interactions
              </label>
              <textarea formControlName="interactions" rows="2" class="form-textarea"
                placeholder="e.g., Avoid with blood thinners, Do not take with grapefruit..."></textarea>
            </div>

            <!-- Notes -->
            <div class="form-field-full">
              <label class="form-label form-label-icon">
                <fa-icon [icon]="faFileMedical" class="w-4 h-4" style="color: #4b5563;"></fa-icon>
                Additional Notes
              </label>
              <textarea formControlName="notes" rows="3" class="form-textarea"
                placeholder="Any additional notes or observations..."></textarea>
            </div>
          </div>
        </form>
      </div>

      <!-- Modal Footer -->
      <div class="modal-footer">
        <div></div>
        <div class="modal-footer-right">
          <button type="button" (click)="closeAddMedicationModal()" class="form-button form-button-cancel">
            Cancel
          </button>
          <button type="button" (click)="addMedication()" [disabled]="!medicationForm.valid"
            class="form-button form-button-submit">
            <fa-icon [icon]="faPlus" class="w-4 h-4"></fa-icon>
            Add Medication
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Document Viewer Modal -->
<app-document-viewer [isOpen]="showDocumentViewer" [document]="currentDocument" (closeEvent)="closeDocumentViewer()">
</app-document-viewer>

<!-- Diet Plan Modal -->
<div *ngIf="showDietPlanModal && currentViewedDietPlan as plan" class="modal-overlay" (click)="closeDietPlanModal()">
  <div class="modal-container">
    <div class="modal-backdrop"></div>

    <div class="modal-panel modal-panel-xl" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-header-content">
          <div class="modal-header-left">
            <div class="modal-icon-container modal-icon-container-green">
              <span class="diet-icon">ðŸ¥—</span>
            </div>
            <div class="modal-title-group">
              <h3 class="modal-title">{{ plan.name }}</h3>
              <p class="modal-subtitle">Complete Diet Plan</p>
            </div>
          </div>
          <button (click)="closeDietPlanModal()" class="modal-close-btn">
            <fa-icon [icon]="faTimes" class="w-6 h-6"></fa-icon>
          </button>
        </div>
      </div>

      <div class="modal-body">
        <!-- <div class="diet-modal-summary">
          <div>
            <p class="diet-modal-label">Start Â· Review</p>
            <p class="diet-modal-value">{{ plan.startDate | date: 'MMM d, y' }} Â· {{ plan.reviewDate | date: 'MMM d, y'
              }}</p>
          </div>
          <div>
            <p class="diet-modal-label">Hydration goal</p>
            <p class="diet-modal-value">{{ plan.hydrationGoal }}</p>
          </div>
          <div>
            <p class="diet-modal-label">Supplements</p>
            <p class="diet-modal-value">{{ plan.supplements.join(', ') }}</p>
          </div>
        </div> -->

        <!-- <div class="diet-macro-summary">
          <div class="macro-card" *ngFor="let metric of macroStatDefinitions">
            <span class="macro-card-label">Weekly {{ metric.label }}</span>
            <span class="macro-card-value">{{ getWeeklyMacroTotals()[metric.key] }} {{ metric.unit }}</span>
            <span class="macro-card-sub">Across 7-day plan</span>
          </div>
        </div> -->

        <div class="diet-week-nav">
          <button class="diet-day-pill" *ngFor="let day of plan.weeklyPlan; let i = index"
            [class.diet-day-pill-active]="i === selectedDayIndex" (click)="selectDietDay(i)">
            <span class="pill-day">{{ day.day | slice: 0:3 }}</span>
            <!-- <span class="pill-focus">{{ day.focus }}</span> -->
          </button>
        </div>

        <ng-container *ngIf="getSelectedDayPlan() as selectedDay">
          <div class="diet-weekly-plan">
            <div class="diet-day-card">
              <div class="diet-day-header">
                <div>
                  <p class="diet-day-name">{{ selectedDay.day | titlecase }}</p>
                  <!-- <p class="diet-day-focus">{{ selectedDay.focus }}</p> -->
                </div>
                <ng-container *ngIf="getDayMacroTotals(selectedDay) as dayTotals">
                  <div class="diet-day-macro-chips">
                    <span class="diet-macro-chip" *ngFor="let metric of macroStatDefinitions">
                      <span>{{ metric.label }}</span>
                      <strong>{{ dayTotals[metric.key] }} {{ metric.unit }}</strong>
                    </span>
                  </div>
                </ng-container>
              </div>

              <div class="diet-meal-list">
                <div class="diet-meal-card" *ngFor="let meal of selectedDay.meals">
                  <div>
                    <p class="diet-meal-name">{{ meal.name }}</p>
                    <p class="diet-meal-time">{{ meal.time }}</p>
                    <p class="diet-meal-foods">{{ meal.foods.join(' â€¢ ') }}</p>
                  </div>
                  <div class="diet-meal-macros">
                    <div class="diet-meal-macro">
                      <span>Calories</span>
                      <strong>{{ meal.macros.calories }} kcal</strong>
                    </div>
                    <div class="diet-meal-macro">
                      <span>Protein</span>
                      <strong>{{ meal.macros.protein }} g</strong>
                    </div>
                    <div class="diet-meal-macro">
                      <span>Carbs</span>
                      <strong>{{ meal.macros.carbs }} g</strong>
                    </div>
                    <div class="diet-meal-macro">
                      <span>Fats</span>
                      <strong>{{ meal.macros.fat }} g</strong>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </ng-container>
      </div>

      <div class="modal-footer">
        <div class="modal-footer-info">
          {{ plan.weeklyPlan.length }}-day plan Â· {{ getTotalMealsScheduled() }} meals scheduled
        </div>
        <div class="modal-footer-right">
          <button class="modal-footer-button modal-footer-button-secondary" (click)="closeDietPlanModal()">
            Close
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- AI Diet Plan Instructions Modal -->
<div *ngIf="showAIDietInstructionsModal" class="modal-overlay" (click)="closeAIDietInstructionsModal()">
  <div class="modal-container">
    <div class="modal-backdrop"></div>

    <div class="modal-panel modal-panel-md ai-modal-panel" (click)="$event.stopPropagation()">
      <div class="modal-header ai-modal-header">
        <div class="modal-header-content">
          <div class="modal-header-left">
            <div class="modal-icon-container ai-icon-container">
              <fa-icon [icon]="faWandMagicSparkles" class="ai-modal-icon"></fa-icon>
            </div>
            <div class="modal-title-group">
              <h3 class="modal-title">AI Diet Plan Generation</h3>
              <p class="modal-subtitle">Provide instructions for the AI to generate a personalized diet plan</p>
            </div>
          </div>
          <button (click)="closeAIDietInstructionsModal()" class="modal-close-btn" [disabled]="isGeneratingDietPlan">
            <fa-icon [icon]="faTimes" class="w-6 h-6"></fa-icon>
          </button>
        </div>
      </div>

      <div class="modal-body ai-modal-body">
        <div class="ai-instructions-form">
          <label class="ai-label">
            <span class="ai-label-text">Doctor's Instructions</span>
            <span class="ai-label-hint">Describe patient's dietary needs, restrictions, goals, or any specific requirements</span>
          </label>
          <textarea
            [(ngModel)]="aiDietInstructions"
            placeholder="Example: Create a low-carb diet plan for a diabetic patient with hypertension. Focus on high-fiber foods, limit sodium intake, and include heart-healthy fats. Patient is vegetarian and allergic to nuts."
            class="ai-textarea"
            rows="8"
            [disabled]="isGeneratingDietPlan"
          ></textarea>

          <div class="ai-examples">
            <p class="ai-examples-title">Suggested prompts:</p>
            <div class="ai-example-chips">
              <button
                class="ai-example-chip"
                (click)="aiDietInstructions = 'Create a balanced diet plan for weight management with focus on portion control'"
                [disabled]="isGeneratingDietPlan">
                Weight Management
              </button>
              <button
                class="ai-example-chip"
                (click)="aiDietInstructions = 'Design a low-sodium, heart-healthy diet for a patient with cardiovascular concerns'"
                [disabled]="isGeneratingDietPlan">
                Heart Health
              </button>
              <button
                class="ai-example-chip"
                (click)="aiDietInstructions = 'Generate a diabetic-friendly diet plan with low glycemic index foods'"
                [disabled]="isGeneratingDietPlan">
                Diabetes Care
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer ai-modal-footer">
        <div class="modal-footer-info">
          <fa-icon [icon]="faWandMagicSparkles" class="ai-footer-icon"></fa-icon>
          <span>AI-powered personalized diet plan</span>
        </div>
        <div class="modal-footer-right">
          <button
            class="modal-footer-button modal-footer-button-secondary"
            (click)="closeAIDietInstructionsModal()"
            [disabled]="isGeneratingDietPlan">
            Cancel
          </button>
          <button
            class="modal-footer-button modal-footer-button-primary ai-generate-btn"
            (click)="submitDietPlanGeneration()"
            [disabled]="isGeneratingDietPlan || !aiDietInstructions.trim()">
            <fa-icon [icon]="faWandMagicSparkles" *ngIf="!isGeneratingDietPlan"></fa-icon>
            <span *ngIf="!isGeneratingDietPlan">Generate Diet</span>
            <span *ngIf="isGeneratingDietPlan">Generating...</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

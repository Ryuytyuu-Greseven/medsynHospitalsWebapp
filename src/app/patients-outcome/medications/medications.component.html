<div class="main-grid">


  <!-- Medication Insights -->
  <!-- <div class="mb-6">
      <div class="card card-hover-lift card-h-fit card-min-h-300">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-lg font-bold text-gray-900">Medication Insights</h3>
          <fa-icon [icon]="faExclamationTriangle" class="w-5 h-5 text-blue-600"></fa-icon>
        </div>

        <div class="grid grid-cols-2 gap-3 mb-3">
          <div class="bg-blue-50 rounded-lg p-3 text-center">
            <div class="text-xl font-bold text-blue-600">{{ medications.length }}</div>
            <div class="text-xs text-blue-700">Active Meds</div>
          </div>
          <div class="bg-green-50 rounded-lg p-3 text-center">
            <div class="text-xl font-bold text-green-600">{{ getUpcomingRefills() }}</div>
            <div class="text-xs text-green-700">Refills Due</div>
          </div>
        </div>

        <div>
          <h4 class="text-sm font-semibold text-gray-700 mb-2">Recent Activity</h4>
          <div class="space-y-1">
            <div *ngFor="let activity of getRecentActivity()" class="flex items-center gap-2 text-xs text-gray-600">
              <fa-icon [icon]="activity.icon" class="w-3 h-3" [class]="activity.colorClass"></fa-icon>
              <span>{{ activity.description }}</span>
            </div>
          </div>
        </div>
      </div>
    </div> -->

  <!-- Left Side - Medications -->
  <div class="medications-container">

    <!-- Current Medications -->
    <div class="medications-section">
      <div class="card card-hover-lift card-mid">
        <div class="medications-header">
          <h3 class="medications-title">Current Medications</h3>
          <div class="header-actions">
            <!-- Search Input -->
            <div class="search-container">
              <input type="text" [(ngModel)]="quickSearchTerm" (keyup.enter)="quickSearchMedication()"
                placeholder="Search medications..." class="search-input-sm" />
              <fa-icon [icon]="faSearch" class="search-icon"></fa-icon>
            </div>
            <!-- <div class="flex items-center gap-2 border-l border-gray-200 pl-3">
            <span class="text-xs text-gray-500">{{ medications.length || 0 }} active</span>
            <button (click)="openMedicationsModal()" class="text-xs text-blue-600 hover:text-blue-800 font-medium">View All</button>
          </div> -->
          </div>
        </div>

        <!-- Empty State -->
        <div *ngIf="!medications || medications.length === 0" class="empty-state">
          <div class="empty-state-icon-container">
            <fa-icon [icon]="faPills" class="empty-state-icon"></fa-icon>
          </div>
          <p class="empty-state-text">No active medications</p>
        </div>

        <!-- Medications Grid Layout -->
        <div *ngIf="medications && medications.length > 0" class="medications-grid">
          <div *ngFor="let meds of medications; let i = index" class="medication-card">
            <!-- Active Status Indicator -->
            <div *ngIf="meds.status === 'active'" class="active-indicator"></div>

            <div class="medication-content">
              <h4 class="medication-name">{{ meds.name }}</h4>
              <div class="medication-details">
                <div class="medication-dosage">{{ meds.dosage }}</div>
                <div>{{ meds.frequency }}</div>
                <div class="medication-date">
                  <p>{{ formatDate(meds.startDate) }}</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Show More Button -->
        <div *ngIf="medications.length > 8" class="show-more-container">
          <button class="show-more-btn">
            Show {{ medications.length - 8 }} more medications
          </button>
        </div>
      </div>
    </div>

    <!-- Previous Medications -->
    <!-- <div class="mb-6">
      <div class="card card-hover-lift">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-bold text-gray-900">Previous Medications</h3>
        <div class="flex items-center gap-2">
          <span class="text-xs text-gray-500">0 discontinued</span>
          <button class="text-xs text-blue-600 hover:text-blue-800 font-medium">View All</button>
        </div>
      </div>

      <div class="text-center py-6">
        <div class="w-10 h-10 mx-auto bg-gray-100 rounded-full flex items-center justify-center mb-2">
          <fa-icon [icon]="faCheckCircle" class="w-5 h-5 text-gray-400"></fa-icon>
        </div>
        <p class="text-gray-500 text-sm">No previous medications</p>
      </div>
    </div>
    </div> -->
  </div>


  <!-- Quick Actions -->
  <div class="section-spacing">
    <div class="card card-hover-lift card-h-fit card-min-h-300">
      <div class="quick-actions-header">
        <h3 class="quick-actions-title">Quick Actions</h3>
        <fa-icon [icon]="faPlus" class="quick-actions-icon"></fa-icon>
      </div>

      <div class="quick-actions-list">
        <button (click)="openImageUpload()" class="action-button action-button-blue">
          <div class="action-button-content">
            <fa-icon [icon]="faCamera" class="action-icon" style="color: #2563eb;"></fa-icon>
            <div class="action-text">
              <div class="action-title">Scan Prescription</div>
              <div class="action-subtitle">Upload image or PDF</div>
            </div>
          </div>
        </button>

        <button (click)="openAddMedicationModal()" class="action-button action-button-green">
          <div class="action-button-content">
            <fa-icon [icon]="faPills" class="action-icon" style="color: #16a34a;"></fa-icon>
            <div class="action-text">
              <div class="action-title">Add Manually</div>
              <div class="action-subtitle">Enter details manually</div>
            </div>
          </div>
        </button>

        <button (click)="exportMedications()" class="action-button action-button-purple">
          <div class="action-button-content">
            <fa-icon [icon]="faDownload" class="action-icon" style="color: #9333ea;"></fa-icon>
            <div class="action-text">
              <div class="action-title">Export List</div>
              <div class="action-subtitle">Download medication list</div>
            </div>
          </div>
        </button>
      </div>
    </div>
  </div>

  <!-- Nutrition & Activity -->
  <div class="section-spacing">
    <div class="card card-hover-lift card-h-fit card-min-h-300">
      <h3 class="nutrition-header">Daily Nutrition & Activity</h3>

      <div class="nutrition-section">
        <h4 class="nutrition-section-title">Nutrition Intake</h4>
        <div class="nutrition-grid">
          <div class="nutrition-card nutrition-card-orange">
            <div class="nutrition-value nutrition-value-orange">1,850</div>
            <div class="nutrition-label nutrition-label-orange">Calories</div>
          </div>

          <div class="nutrition-card nutrition-card-blue">
            <div class="nutrition-value nutrition-value-blue">85g</div>
            <div class="nutrition-label nutrition-label-blue">Protein</div>
          </div>

          <div class="nutrition-card nutrition-card-yellow">
            <div class="nutrition-value nutrition-value-yellow">120g</div>
            <div class="nutrition-label nutrition-label-yellow">Carbs</div>
          </div>

          <div class="nutrition-card nutrition-card-purple">
            <div class="nutrition-value nutrition-value-purple">65g</div>
            <div class="nutrition-label nutrition-label-purple">Fat</div>
          </div>
        </div>
      </div>

      <div>
        <h4 class="nutrition-section-title">Activity & Burning</h4>
        <div class="nutrition-grid">
          <div class="nutrition-card nutrition-card-red">
            <div class="nutrition-value nutrition-value-red">420</div>
            <div class="nutrition-label nutrition-label-red">Calories Burned</div>
          </div>

          <div class="nutrition-card nutrition-card-green">
            <div class="nutrition-value nutrition-value-green">6,250</div>
            <div class="nutrition-label nutrition-label-green">Steps</div>
          </div>

          <div class="nutrition-card nutrition-card-blue">
            <div class="nutrition-value nutrition-value-blue">3.2</div>
            <div class="nutrition-label nutrition-label-blue">Miles</div>
          </div>

          <div class="nutrition-card nutrition-card-purple">
            <div class="nutrition-value nutrition-value-purple">45</div>
            <div class="nutrition-label nutrition-label-purple">Active Minutes</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Current Diet -->
  <div class="section-spacing" *ngIf="dietPlan as plan">
    <div class="card card-hover-lift card-h-fit card-mid">
      <div class="diet-header">
        <div class="diet-title-meta">
          <h3 class="diet-title">Current Diet Plan</h3>
          <span class="diet-subtitle">Started {{ plan.startDate | date: 'MMM d, y' }}</span>
        </div>
        <div class="diet-header-actions">
          <!-- <span class="diet-badge" *ngIf="plan.badge">{{ plan.badge }}</span> -->
          <button class="diet-view-btn" (click)="openDietPlanModal()">View plan</button>
        </div>
      </div>

      <div class="diet-card">
        <div class="diet-card-header">
          <div class="diet-icon-container">
            <span class="diet-icon">ðŸ¥—</span>
          </div>
          <div class="diet-info">
            <h4 class="diet-name">{{ plan.name }}</h4>
            <p class="diet-description">{{ plan.description }}</p>
          </div>
        </div>

        <div class="diet-summary-inline">
          <div class="diet-summary-field">
            <span class="diet-summary-label">Prescribed by</span>
            <span class="diet-summary-value">{{ plan.doctor }}</span>
          </div>
        </div>

        <div class="diet-targets">
          <div class="diet-target" *ngFor="let metric of macroStatDefinitions">
            <span class="diet-target-label">{{ metric.label }}</span>
            <span class="diet-target-value">{{ plan.dailyTargets[metric.key] }} {{ metric.unit }}</span>
            <span class="diet-target-subtext">Daily target</span>
          </div>
        </div>

        <!-- <div class="diet-week-preview">
          <div class="diet-week-day" *ngFor="let day of plan.weeklyPlan | slice:0:3">
            <div class="diet-week-day-header">
              <span class="diet-week-day-name">{{ day.day }}</span>
              <span class="diet-week-day-focus">{{ day.focus }}</span>
            </div>
            <div class="diet-week-meals">
              <div class="diet-week-meal" *ngFor="let meal of day.meals | slice:0:2">
                <span class="diet-week-meal-name">{{ meal.name }}</span>
                <span class="diet-week-meal-macros">{{ meal.macros.calories }} kcal Â· {{ meal.macros.protein }}g P Â·
                  {{ meal.macros.carbs }}g C
                </span>
              </div>
            </div>
          </div>
        </div> -->

        <!-- <div class="diet-actions">
          <div class="diet-note">
            <strong>Notes:</strong> {{ plan.notes }}
          </div>
        </div> -->
      </div>
    </div>
  </div>


</div>

<!-- Medications Modal -->
<div *ngIf="showMedicationsModal" class="modal-overlay" (click)="closeMedicationsModal()">
  <div class="modal-container">
    <!-- Background overlay -->
    <div class="modal-backdrop"></div>

    <!-- Modal panel -->
    <div class="modal-panel modal-panel-xl diet-plan-modal" (click)="$event.stopPropagation()">
      <!-- Modal Header -->
      <div class="modal-header">
        <div class="modal-header-content">
          <div class="modal-header-left">
            <div class="modal-icon-container modal-icon-container-blue">
              <fa-icon [icon]="faPills" class="modal-icon modal-icon-blue"></fa-icon>
            </div>
            <div class="modal-title-group">
              <h3 class="modal-title">All Medications</h3>
              <p class="modal-subtitle">Complete medication history and management</p>
            </div>
          </div>
          <button (click)="closeMedicationsModal()" class="modal-close-btn">
            <fa-icon [icon]="faTimes" class="w-6 h-6"></fa-icon>
          </button>
        </div>

        <!-- Search and Filter Bar -->
        <div class="search-filter-bar">
          <div class="search-input-container">
            <div class="relative">
              <input type="text" [(ngModel)]="medicationSearchTerm" (input)="filterMedications()"
                placeholder="Search medications..." class="search-input-full">
              <fa-icon [icon]="faSearch" class="search-icon-absolute"></fa-icon>
            </div>
          </div>
          <div class="filter-actions">
            <select [(ngModel)]="selectedStatusFilter" (change)="filterMedications()" class="filter-select">
              <option value="all">All Status</option>
              <option value="active">Active</option>
              <option value="discontinued">Discontinued</option>
              <option value="paused">Paused</option>
            </select>
            <button (click)="openImageUpload()" class="filter-button">
              <fa-icon [icon]="faCamera" class="w-4 h-4"></fa-icon>
              Scan Prescription
            </button>
          </div>
        </div>
      </div>

      <!-- Modal Body -->
      <div class="modal-body">
        <!-- Current Medications Section -->
        <div class="mb-6">
          <h4 class="medications-section-title">
            <div class="status-dot status-dot-green"></div>
            Current Medications ({{ getFilteredMedications('active').length }})
          </h4>
          <div class="medications-grid-modal">
            <div *ngFor="let med of getFilteredMedications('active')" class="medication-card-modal">
              <div class="medication-card-header">
                <div class="medication-card-content">
                  <div class="medication-name-row">
                    <h5 class="medication-name-modal">{{ med.name }}</h5>
                    <span class="status-badge status-badge-active">
                      Active
                    </span>
                  </div>
                  <div class="medication-details-list">
                    <p class="medication-detail-item"><span class="medication-detail-label">Dosage:</span>
                      {{ med.dosage }}</p>
                    <p class="medication-detail-item"><span class="medication-detail-label">Frequency:</span>
                      {{ med.frequency }}</p>
                    <p class="medication-detail-item"><span class="medication-detail-label">Started:</span>
                      {{ formatDate(med.startDate) }}</p>
                    <p *ngIf="med.prescribedBy" class="medication-detail-item"><span
                        class="medication-detail-label">Prescribed by:</span> {{ med.prescribedBy }}</p>
                    <p *ngIf="med.notes" class="medication-notes">
                      <span class="medication-detail-label">Notes:</span> {{ med.notes }}
                    </p>
                  </div>
                </div>
                <div class="medication-actions">
                  <button (click)="viewPrescription(med)" class="action-icon-btn action-icon-btn-green"
                    title="View Prescription">
                    <fa-icon [icon]="faEye" class="action-icon-size"></fa-icon>
                  </button>
                  <button (click)="editMedication(med)" class="action-icon-btn action-icon-btn-blue" title="Edit">
                    <fa-icon [icon]="faEdit" class="action-icon-size"></fa-icon>
                  </button>
                  <button (click)="discontinueMedication(med)" class="action-icon-btn action-icon-btn-red"
                    title="Discontinue">
                    <fa-icon [icon]="faTimes" class="action-icon-size"></fa-icon>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Previous/Discontinued Medications Section -->
        <div *ngIf="getFilteredMedications('discontinued').length > 0">
          <h4 class="medications-section-title">
            <div class="status-dot status-dot-gray"></div>
            Previous Medications ({{ getFilteredMedications('discontinued').length }})
          </h4>
          <div class="medications-grid-modal">
            <div *ngFor="let med of getFilteredMedications('discontinued')"
              class="medication-card-modal medication-card-disabled">
              <div class="medication-card-header">
                <div class="medication-card-content">
                  <div class="medication-name-row">
                    <h5 class="medication-name-modal">{{ med.name }}</h5>
                    <span class="status-badge status-badge-discontinued">
                      Discontinued
                    </span>
                  </div>
                  <div class="medication-details-list">
                    <p class="medication-detail-item"><span class="medication-detail-label">Dosage:</span>
                      {{ med.dosage }}</p>
                    <p class="medication-detail-item"><span class="medication-detail-label">Duration:</span>
                      {{ formatDate(med.startDate) }} - {{ med.endDate ? formatDate(med.endDate) : 'Ongoing' }}</p>
                    <p *ngIf="med.discontinueReason" class="medication-notes">
                      <span class="medication-detail-label">Reason:</span> {{ med.discontinueReason }}
                    </p>
                  </div>
                </div>
                <div class="medication-actions">
                  <button (click)="viewMedicationHistory(med)" class="action-icon-btn action-icon-btn-gray"
                    title="View History">
                    <fa-icon [icon]="faHistory" class="action-icon-size"></fa-icon>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Empty State -->
        <div *ngIf="getFilteredMedications('all').length === 0" class="empty-state-modal">
          <div class="empty-state-icon-large">
            <fa-icon [icon]="faSearch"></fa-icon>
          </div>
          <p class="empty-state-text-modal">No medications found matching your search criteria</p>
        </div>
      </div>

      <!-- Modal Footer -->
      <div class="modal-footer">
        <div class="modal-footer-info">
          Total: {{ getAllMedications().length }} medications
        </div>
        <div class="modal-footer-right">
          <button (click)="exportMedications()" class="modal-footer-button modal-footer-button-secondary">
            Export List
          </button>
          <button (click)="closeMedicationsModal()" class="modal-footer-button modal-footer-button-primary">
            Close
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Image Upload Modal -->
<div *ngIf="showImageUploadModal" class="modal-overlay" (click)="closeImageUploadModal()">
  <div class="modal-container">
    <!-- Background overlay -->
    <div class="modal-backdrop"></div>

    <!-- Modal panel -->
    <div class="modal-panel" (click)="$event.stopPropagation()">
      <!-- Modal Header -->
      <div class="modal-header">
        <div class="modal-header-content">
          <div class="modal-header-left">
            <div class="modal-icon-container modal-icon-container-blue">
              <fa-icon [icon]="faCamera" class="modal-icon modal-icon-blue"></fa-icon>
            </div>
            <div class="modal-title-group">
              <h3 class="modal-title">Upload Prescription</h3>
              <p class="modal-subtitle">AI will automatically extract medication details</p>
            </div>
          </div>
          <button (click)="closeImageUploadModal()" class="modal-close-btn">
            <fa-icon [icon]="faTimes" class="w-6 h-6"></fa-icon>
          </button>
        </div>
      </div>

      <!-- Modal Body -->
      <div class="modal-body-white px-6 py-4">
        <!-- Upload Area -->
        <div [class]="'upload-area ' + (isUploadingMedication ? 'upload-area-disabled' : '')"
          (click)="!isUploadingMedication && triggerFileInput()"
          (dragover)="!isUploadingMedication && onDragOver($event)"
          (dragleave)="!isUploadingMedication && onDragLeave($event)" (drop)="!isUploadingMedication && onDrop($event)">
          <fa-icon [icon]="faCamera" class="upload-icon-large"></fa-icon>
          <p class="upload-title">Upload Prescription Image</p>
          <p class="upload-subtitle">Drag and drop or click to browse</p>
          <p class="upload-hint">Supports JPG, PNG, PDF files up to 10MB</p>
          <input #fileInput type="file" accept=".jpg,.jpeg,.png,.pdf" class="file-input-hidden"
            (change)="onFileSelected($event)" [disabled]="isUploadingMedication">
        </div>

        <!-- Preview -->
        <div *ngIf="uploadedImage" class="preview-container">
          <h4 class="preview-title">Uploaded Image</h4>
          <div class="preview-image-container">
            <img [src]="uploadedImage" alt="Prescription preview" class="preview-image">
            <button (click)="removeUploadedImage()" [disabled]="isUploadingMedication" class="preview-remove-btn">
              <fa-icon [icon]="faTimes" class="w-3 h-3"></fa-icon>
            </button>
          </div>
        </div>

        <!-- AI Processing -->
        <div *ngIf="isProcessingImage" class="mt-4">
          <app-loading text="AI is analyzing your prescription..." size="md">
          </app-loading>
        </div>

        <!-- Extracted Data Preview -->
        <div *ngIf="extractedMedicationData" class="extracted-data">
          <h4 class="extracted-data-title">Extracted Information</h4>
          <div class="extracted-data-list">
            <div class="extracted-data-item"><span class="extracted-data-label">Medication:</span>
              {{ extractedMedicationData.name }}</div>
            <div class="extracted-data-item"><span class="extracted-data-label">Dosage:</span>
              {{ extractedMedicationData.dosage }}</div>
            <div class="extracted-data-item"><span class="extracted-data-label">Frequency:</span>
              {{ extractedMedicationData.frequency }}</div>
            <div *ngIf="extractedMedicationData.instructions" class="extracted-data-item"><span
                class="extracted-data-label">Instructions:</span> {{ extractedMedicationData.instructions }}</div>
          </div>
          <div class="extracted-data-actions">
            <button (click)="confirmExtractedData()" class="extracted-data-btn extracted-data-btn-confirm">
              Confirm & Add
            </button>
            <button (click)="editExtractedData()" class="extracted-data-btn extracted-data-btn-edit">
              Edit Details
            </button>
          </div>
        </div>
      </div>

      <!-- Modal Footer -->
      <div class="modal-footer">
        <div></div>
        <div class="modal-footer-right">
          <button (click)="closeImageUploadModal()" [disabled]="isUploadingMedication"
            class="form-button form-button-cancel">
            Cancel
          </button>
          <button (click)="processImage()" [disabled]="!uploadedImage || isUploadingMedication"
            class="form-button form-button-process">
            <!-- Loading Spinner - Keep Tailwind for animation -->
            <svg *ngIf="isUploadingMedication" class="animate-spin h-4 w-4 text-white"
              xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor"
                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
              </path>
            </svg>
            <fa-icon *ngIf="!isUploadingMedication" [icon]="faCamera" class="w-4 h-4"></fa-icon>
            <span>{{ isUploadingMedication ? 'Uploading...' : 'Process with AI' }}</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add Medication Modal -->
<div *ngIf="showAddMedicationModal" class="modal-overlay" (click)="closeAddMedicationModal()">
  <div class="modal-container">
    <!-- Background overlay -->
    <div class="modal-backdrop"></div>

    <!-- Modal panel -->
    <div class="modal-panel modal-panel-lg" (click)="$event.stopPropagation()">
      <!-- Modal Header -->
      <div class="modal-header">
        <div class="modal-header-content">
          <div class="modal-header-left">
            <div class="modal-icon-container modal-icon-container-green">
              <fa-icon [icon]="faPills" class="modal-icon modal-icon-green"></fa-icon>
            </div>
            <div class="modal-title-group">
              <h3 class="modal-title">Add New Medication</h3>
              <p class="modal-subtitle">Enter medication details and dosage information</p>
            </div>
          </div>
          <button (click)="closeAddMedicationModal()" class="modal-close-btn">
            <fa-icon [icon]="faTimes" class="w-6 h-6"></fa-icon>
          </button>
        </div>
      </div>

      <!-- Modal Body -->
      <div class="modal-body-white px-6 py-4">
        <form [formGroup]="medicationForm" (ngSubmit)="addMedication()">
          <div class="form-grid">
            <!-- Medication Name -->
            <div class="form-field-full">
              <label class="form-label form-label-icon">
                <fa-icon [icon]="faPills" class="w-4 h-4" style="color: #2563eb;"></fa-icon>
                Medication Name *
              </label>
              <input type="text" formControlName="name" class="form-input" placeholder="e.g., Metformin, Lisinopril">
            </div>

            <!-- Dosage -->
            <div>
              <label class="form-label form-label-icon">
                <fa-icon [icon]="faExclamationTriangle" class="w-4 h-4" style="color: #ea580c;"></fa-icon>
                Dosage *
              </label>
              <input type="text" formControlName="dosage" class="form-input" placeholder="e.g., 500mg, 10mg">
            </div>

            <!-- Frequency -->
            <div>
              <label class="form-label form-label-icon">
                <fa-icon [icon]="faCalendarAlt" class="w-4 h-4" style="color: #9333ea;"></fa-icon>
                Frequency *
              </label>
              <select formControlName="frequency" class="form-select">
                <option value="">Select frequency</option>
                <option value="Once daily">Once daily</option>
                <option value="Twice daily">Twice daily</option>
                <option value="Three times daily">Three times daily</option>
                <option value="Four times daily">Four times daily</option>
                <option value="As needed">As needed</option>
                <option value="Weekly">Weekly</option>
                <option value="Monthly">Monthly</option>
              </select>
            </div>

            <!-- Times Per Day -->
            <div>
              <label class="form-label form-label-icon">
                <fa-icon [icon]="faCalendarAlt" class="w-4 h-4" style="color: #16a34a;"></fa-icon>
                Times Per Day
              </label>
              <input type="number" formControlName="timesPerDay" min="1" max="10" class="form-input"
                placeholder="e.g., 2">
            </div>

            <!-- Start Date -->
            <div>
              <label class="form-label form-label-icon">
                <fa-icon [icon]="faCalendarAlt" class="w-4 h-4" style="color: #2563eb;"></fa-icon>
                Start Date *
              </label>
              <input type="date" formControlName="startDate" class="form-input">
            </div>

            <!-- Prescribed By -->
            <div>
              <label class="form-label form-label-icon">
                <fa-icon [icon]="faUserMd" class="w-4 h-4" style="color: #6366f1;"></fa-icon>
                Prescribed By
              </label>
              <input type="text" formControlName="prescribedBy" class="form-input" placeholder="e.g., Dr. Smith">
            </div>

            <!-- Description -->
            <div class="form-field-full">
              <label class="form-label form-label-icon">
                <fa-icon [icon]="faFileMedical" class="w-4 h-4" style="color: #14b8a6;"></fa-icon>
                Description
              </label>
              <textarea formControlName="description" rows="2" class="form-textarea"
                placeholder="Brief description of the medication and its purpose..."></textarea>
            </div>

            <!-- Instructions -->
            <div class="form-field-full">
              <label class="form-label form-label-icon">
                <fa-icon [icon]="faFileMedical" class="w-4 h-4" style="color: #f59e0b;"></fa-icon>
                Special Instructions
              </label>
              <textarea formControlName="instructions" rows="2" class="form-textarea"
                placeholder="e.g., Take with food, Take before bedtime, Avoid alcohol..."></textarea>
            </div>

            <!-- Side Effects -->
            <div class="form-field-full">
              <label class="form-label form-label-icon">
                <fa-icon [icon]="faExclamationTriangle" class="w-4 h-4" style="color: #dc2626;"></fa-icon>
                Potential Side Effects
              </label>
              <textarea formControlName="sideEffects" rows="2" class="form-textarea"
                placeholder="e.g., Nausea, dizziness, headache..."></textarea>
            </div>

            <!-- Drug Interactions -->
            <div class="form-field-full">
              <label class="form-label form-label-icon">
                <fa-icon [icon]="faExclamationTriangle" class="w-4 h-4" style="color: #ea580c;"></fa-icon>
                Drug Interactions
              </label>
              <textarea formControlName="interactions" rows="2" class="form-textarea"
                placeholder="e.g., Avoid with blood thinners, Do not take with grapefruit..."></textarea>
            </div>

            <!-- Notes -->
            <div class="form-field-full">
              <label class="form-label form-label-icon">
                <fa-icon [icon]="faFileMedical" class="w-4 h-4" style="color: #4b5563;"></fa-icon>
                Additional Notes
              </label>
              <textarea formControlName="notes" rows="3" class="form-textarea"
                placeholder="Any additional notes or observations..."></textarea>
            </div>
          </div>
        </form>
      </div>

      <!-- Modal Footer -->
      <div class="modal-footer">
        <div></div>
        <div class="modal-footer-right">
          <button type="button" (click)="closeAddMedicationModal()" class="form-button form-button-cancel">
            Cancel
          </button>
          <button type="button" (click)="addMedication()" [disabled]="!medicationForm.valid"
            class="form-button form-button-submit">
            <fa-icon [icon]="faPlus" class="w-4 h-4"></fa-icon>
            Add Medication
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Document Viewer Modal -->
<app-document-viewer [isOpen]="showDocumentViewer" [document]="currentDocument" (closeEvent)="closeDocumentViewer()">
</app-document-viewer>

<!-- Diet Plan Modal -->
<div *ngIf="showDietPlanModal && dietPlan as plan" class="modal-overlay" (click)="closeDietPlanModal()">
  <div class="modal-container">
    <div class="modal-backdrop"></div>

    <div class="modal-panel modal-panel-xl" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-header-content">
          <div class="modal-header-left">
            <div class="modal-icon-container modal-icon-container-green">
              <span class="diet-icon">ðŸ¥—</span>
            </div>
            <div class="modal-title-group">
              <h3 class="modal-title">Complete Diet Plan</h3>
              <p class="modal-subtitle">{{ plan.name }} Â· {{ plan.doctor }}</p>
            </div>
          </div>
          <button (click)="closeDietPlanModal()" class="modal-close-btn">
            <fa-icon [icon]="faTimes" class="w-6 h-6"></fa-icon>
          </button>
        </div>
      </div>

      <div class="modal-body">
        <div class="diet-modal-summary">
          <div>
            <p class="diet-modal-label">Start Â· Review</p>
            <p class="diet-modal-value">{{ plan.startDate | date: 'MMM d, y' }} Â· {{ plan.reviewDate | date: 'MMM d, y'
              }}</p>
          </div>
          <div>
            <p class="diet-modal-label">Hydration goal</p>
            <p class="diet-modal-value">{{ plan.hydrationGoal }}</p>
          </div>
          <div>
            <p class="diet-modal-label">Supplements</p>
            <p class="diet-modal-value">{{ plan.supplements.join(', ') }}</p>
          </div>
        </div>

        <div class="diet-macro-summary">
          <div class="macro-card" *ngFor="let metric of macroStatDefinitions">
            <span class="macro-card-label">Weekly {{ metric.label }}</span>
            <span class="macro-card-value">{{ getWeeklyMacroTotals()[metric.key] }} {{ metric.unit }}</span>
            <span class="macro-card-sub">Across 7-day plan</span>
          </div>
        </div>

        <div class="diet-week-nav">
          <button class="diet-day-pill" *ngFor="let day of plan.weeklyPlan; let i = index"
            [class.diet-day-pill-active]="i === selectedDayIndex" (click)="selectDietDay(i)">
            <span class="pill-day">{{ day.day | slice: 0:3 }}</span>
            <!-- <span class="pill-focus">{{ day.focus }}</span> -->
          </button>
        </div>

        <ng-container *ngIf="getSelectedDayPlan() as selectedDay">
          <div class="diet-weekly-plan">
            <div class="diet-day-card">
              <div class="diet-day-header">
                <div>
                  <p class="diet-day-name">{{ selectedDay.day }}</p>
                  <p class="diet-day-focus">{{ selectedDay.focus }}</p>
                </div>
                <ng-container *ngIf="getDayMacroTotals(selectedDay) as dayTotals">
                  <div class="diet-day-macro-chips">
                    <span class="diet-macro-chip" *ngFor="let metric of macroStatDefinitions">
                      <span>{{ metric.label }}</span>
                      <strong>{{ dayTotals[metric.key] }} {{ metric.unit }}</strong>
                    </span>
                  </div>
                </ng-container>
              </div>

              <div class="diet-meal-list">
                <div class="diet-meal-card" *ngFor="let meal of selectedDay.meals">
                  <div>
                    <p class="diet-meal-name">{{ meal.name }}</p>
                    <p class="diet-meal-time">{{ meal.time }}</p>
                    <p class="diet-meal-foods">{{ meal.foods.join(' â€¢ ') }}</p>
                  </div>
                  <div class="diet-meal-macros">
                    <div class="diet-meal-macro">
                      <span>Calories</span>
                      <strong>{{ meal.macros.calories }} kcal</strong>
                    </div>
                    <div class="diet-meal-macro">
                      <span>Protein</span>
                      <strong>{{ meal.macros.protein }} g</strong>
                    </div>
                    <div class="diet-meal-macro">
                      <span>Carbs</span>
                      <strong>{{ meal.macros.carbs }} g</strong>
                    </div>
                    <div class="diet-meal-macro">
                      <span>Fats</span>
                      <strong>{{ meal.macros.fat }} g</strong>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </ng-container>
      </div>

      <div class="modal-footer">
        <div class="modal-footer-info">
          {{ plan.weeklyPlan.length }}-day plan Â· {{ getTotalMealsScheduled() }} meals scheduled
        </div>
        <div class="modal-footer-right">
          <button class="modal-footer-button modal-footer-button-secondary" (click)="closeDietPlanModal()">
            Close
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
